#!/bin/sh

. lib/core
. lib/shable


_inventory="${1}"
_reign="${2}"
_remote="${3}"
_sshd_port="${4:-${DEFAULT_SSH_PORT}}"

if [ -z "${_inventory}" ]; then
    error "Inventory to read inputs from is required as 1st param!"
else
    if [ -z "${_reign}" ]; then
        error "Reign task name required as 2nd param!"
    else
        if [ -z "${_remote}" ]; then
            error "Client name is required as 3rd param!"
        else
            # NOTE:
            # 1. build tarball from cwd
            # 2. scp tarball to remote
            # 3. unpack on remote
            # 4. invoke Shable
            #

            # Read base.facts - cause bin/reign can make use of base facts too
            if [ -f "facts/base.facts" ]; then
                debug "+ base facts: $(distd "facts/base.facts")"
                . "facts/base.facts"
            fi

            debug "Using inventory file: $(distd "inventory"), client: $(distd "${_remote}")"
            _inventory_values="$(${GREP_BIN} -E "^${_remote}\ " "${_inventory}" | ${HEAD_BIN} -n1 | ${CUT_BIN} -d' ' -f2-)"
            if [ -n "${_inventory_values}" ]; then
                debug "Defined $(distd "_inventory_values"): $(distd "${_inventory_values}")"
                eval "export ${_inventory_values}" >/dev/null 2>/dev/null
            else
                debug "Defined no $(distd "_inventory_values") for remote: $(distd "${_remote}")"
            fi

            _base_name="/tmp/shable_current"

            validate \
                connection_timeout="${connection_timeout}" \
                connection_attempts="${connection_attempts}"

            commit_failure () {
                warn "Reign FAILED: $(distw "${_reign}") for host: $(distw "${_remote}"). Reason: ${*}"
                error "${*}"
            }

            sync_with_rsync () {
                for _attempt in 1 2 3; do
                    ${RSYNC_BIN} \
                        --timeout=2 \
                        --exclude=".git" \
                        --recursive \
                        --compress \
                        --archive \
                        --delete \
                        "./" \
                        "root@${_remote}:${_base_name}" 2>/dev/null
                    if [ "0" = "$?" ]; then
                        # Core Shable repository was synchronised, now time for siblings!
                        for _sibling in ${DEFAULT_REMOTEDIR}/*; do
                            debug "Syncing sibling: $(distd "${_sibling}") to $(distd "root@${_remote}:${_base_name}")"
                            ${RSYNC_BIN} \
                                --exclude=".git" \
                                --recursive \
                                --compress \
                                --archive \
                                "${_sibling}/" \
                                "root@${_remote}:${_base_name}" 2>/dev/null
                                if [ "0" != "$?" ]; then
                                    return 1
                                fi
                        done
                        return 0
                    fi
                done
                return 1
            }

            debug "Rsyncing Shable to: $(distd "${_base_name}")"
            sync_with_rsync || commit_failure "Failed to rsync to: $(distw "root@${_remote}:${_base_name}")"

            _job="cd ${_base_name}; \
                export ${_inventory_values} commands='${commands}' domain='${domain}' _remote='${_remote}' && \
                DEBUG=${DEBUG} SKIP_ENV_VALIDATION=${SKIP_ENV_VALIDATION} build_uuid='${build_uuid}' silk_branch='${silk_branch}' bin/shable ${_reign}"

            invoke_ssh () {
                debug "Invoking remote job: $(distd "invoke_ssh('${_job}')")"
                for _attempt in 1 2 3; do
                    debug "Job attempt: $(distd "${_attempt}")"
                    ${SSH_BIN} -tt \
                        -o "BatchMode=yes" \
                        -o "ConnectTimeout=${connection_timeout}" \
                        -o "ConnectionAttempts=${connection_attempts}" \
                        -o "ServerAliveInterval=1" \
                        "${_remote}" \
                        "${_job}"

                    if [ "0" = "$?" ]; then
                        debug "Job successful"
                        return 0
                    else
                        debug "Job unsuccessful, attempt: $(distd "${_attempt}")"
                        sleep 1
                    fi
                done
                return 1
            }

            debug "Invoking Shable on remote: $(distd "${_remote}")"
            invoke_ssh || commit_failure "Failed to invoke ssh connection to remote: $(diste "${_remote}")"

            note "Reign completed: $(distn "${_reign}")"
        fi
    fi
fi
